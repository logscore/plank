services:
  plank:
    container_name: plank-dev
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
    ports:
      - "3300:3000"
      - "6881:6881/tcp"
      - "6881:6881/udp"
    environment:
      - NODE_ENV=development
      - ENABLE_FILE_STORAGE=true
      - DATABASE_URL=/app/plank.db
      - TMDB_API_KEY=${TMDB_API_KEY}
      # Internal Docker network URLs (always use service names)
      - PROWLARR_URL=http://prowlarr:9696
      - PROWLARR_API_KEY=${PROWLARR_API_KEY:-}
      - OPENSUBTITLES_API_KEY=${OPENSUBTITLES_API_KEY:-}
      - OPENSUBTITLES_USERNAME=${OPENSUBTITLES_USERNAME:-}
      - OPENSUBTITLES_PASSWORD=${OPENSUBTITLES_PASSWORD:-}
      - FLARESOLVERR_URL=http://flaresolverr:8191
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - BETTER_AUTH_URL=${BETTER_AUTH_URL}
      # Required for SvelteKit CSRF protection to accept requests from the host port
      - ORIGIN=${ORIGIN:-http://localhost:3300}
      # Tell Node adapter to listen on all interfaces (internal port)
      - PORT=3000
      - HOST=0.0.0.0
      # Path to Prowlarr config for auto-configuration
      - PROWLARR_CONFIG_PATH=/prowlarr-config/config.xml
    volumes:
      # Mount source code for hot reloading
      - ..:/app
      # Preserve container's node_modules (hide local node_modules)
      - /app/node_modules
      - plank-data:/app/data
      - ${MEDIA_PATH:-./media}:/app/data/library
      # Share Prowlarr config for API key extraction
      - prowlarr-config:/prowlarr-config:ro
    command: npm run dev -- --host
    depends_on:
      prowlarr:
        condition: service_started
    restart: unless-stopped

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/New_York}
    volumes:
      - prowlarr-config:/config
    ports:
      - "9696:9696"
    restart: unless-stopped
    depends_on:
      - flaresolverr

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_HTML=${LOG_HTML:-false}
      - CAPTCHA_SOLVER=${CAPTCHA_SOLVER:-none}
      - TZ=${TZ:-America/New_York}
    ports:
      - "8191:8191"
    restart: unless-stopped

volumes:
  plank-db:
  plank-data:
  prowlarr-config:
